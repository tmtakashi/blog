---
title: WAVファイルの構造&C言語での読み書き
date: 2020-04-27T11:10:20.161Z
description: wavファイルについて
---
## WAVファイルの内容について

WAV ファイルは RIFF チャンクと呼ばれるブロック構造によって記述されています。 この RIFF チャンクの中には「fmt チャンク」と「data チャンク」が含まれており、前者は標本化周波数、量子化ビット数などのファイルのプロパティ情報、後者は音の波形データそのものが格納されています。

#### RIFFチャンクの先頭

| パラメータ     | バイト数 | 内容         |
|-----------|------|------------|
| chunkID   | 4    | "RIFF"     |
| chunkSize | 4    | サンプル数 + 16 |
| formType  | 4    | "WAVE"     |

#### fmtチャンク

| パラメータ          | バイト数 | 内容                                                                 |
|----------------|------|--------------------------------------------------------------------|
| chunkID        | 4    | "fmt "                                                             |
| chunkSize      | 4    | 16                                                                 |
| waveFormatType | 2    | 音データの形式。PCMの場合1                                                    |
| channel        | 2    | モノラルの場合1、ステレオの場合2                                                  |
| samplesPerSec  | 4    | 標本化周波数                                                             |
| bytesPerSec    | 4    | 1秒間の音データを記録するのに必要なデータ量(byte)。blockSize * samplesPerSec             |
| blockSize      | 2    | (byte / sample)  *channel。 16bitステレオの場合 2 \[byte / sample]*  2 = 4 |
| bitsPerSample  | 2    | bitを単位とする量子化精度。8bitの場合は8, 16bitの場合は16                              |

#### dataチャンク

| パラメータ     | バイト数             | 内容     |
|-----------|------------------|--------|
| chunkID   | 4                | "data" |
| chunkSize | 4                | サンプル数  |
| data      | (1 or 2) * サンプル数 | 音データ   |

dataパラメータには、量子化ビット数が8bitの場合最小値が0、オフセットが128、最大値が256の音データが記録され、 量子化ビット数が16bitの場合最小値が-32768、オフセットが0、最大値が32767の音データが記録されます。
![bit range](/img/bit_range.png)

モノラルの場合は時間が進むにつれて音データが順番に記録されていきます。 ステレオの場合は左チャンネルのデータと右チャンネルのデータが交互に記録されていきます。

![](/img/wave_block.svg)

### バイナリをのぞいてみる
WAVファイルのバイナリをVSCodeの拡張機能、[hexdump for VSCode](https://marketplace.visualstudio.com/items?itemName=slevesque.vscode-hexdump)を使って見てみましょう。
拡張機能をインストールしたあと、`*.wav`ファイルをファイルエクスプローラーで右クリックし、"Show hexdump for file"をクリックすると以下のようにファイルの内容が16進数表記のバイト列として表示されます。
右側に表示されている文字列は各バイトをASCIIで解釈したものになっています。
```
  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 	
00000000: 52 49 46 46 A4 3E 00 00 57 41 56 45 66 6D 74 20    RIFF$>..WAVEfmt.
00000010: 10 00 00 00 01 00 01 00 40 1F 00 00 80 3E 00 00    ........@....>..
00000020: 02 00 10 00 64 61 74 61 80 3E 00 00 00 00 3F 0C    ....data.>....?.
00000030: A1 16 90 1D 00 20 90 1D A1 16 3F 0C 00 00 C1 F3    !.......!.?...As
```
WAVファイルのバイトオーダーは各chunkIDがビッグエンディアン、それ以外はリトルエンディアンで記述されています。

ビッグエンディアンは、例えば`0x1234ABCD`という4 byteのデータがあったときにバイト毎に上位側から`12 34 AB CD`と並べ、それに対しリトルエンディアンは下位側から`CD AB 34 12`と並べます。

いくつか具体的なプロパティを読んでみましょう。
-　チャンネル数は23, 24バイト目の位置(0x00000016~0x00000017番地）を見ると`01 00`と書かれているので、順序を戻すと
0x0001=1、よって1チャンネル（モノラル）。
- 標本化周波数は25〜28バイト目の位置(0x00000018~0x0000001B番地)を見ると`40 1F`と書かれているので、順序を戻すと0x1F40=8000、よって8000Hz
- サンプル数は41〜44バイト目の位置(0x00000028~0x0000002B番地)を見ると`80 3E 00 00`と書かれているので、順序を戻すと
0x3E80=16000, よってサンプル数は16000（標本化周波数は8000Hzなので秒に換算すると2秒）

バイト列を目で読むだけでWAVファイルの基本的な性質が読み取ることができますね。